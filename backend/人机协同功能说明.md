# 人机协同校验功能说明

## 📋 功能概述

人机协同校验功能实现了模型初筛 + 人工复核的工作流程：
- **模型初筛**：模型对所有评论进行情感分析，输出置信度
- **智能判断**：根据置信度阈值，自动标记需要人工复核的评论
- **人工复核**：对低置信度评论进行人工复核，反馈结果用于模型优化

---

## 🎯 核心功能

### 1. 模型初筛与置信度输出

模型对所有评论进行初筛，并输出置信度分数（0.0-1.0）：
- **高置信度**（≥阈值）：模型判断准确，可直接使用
- **低置信度**（<阈值）：模型不确定，需要人工复核

### 2. 自动标记需要人工复核的评论

根据置信度阈值自动判断：
- **置信度区间规则**：
  - `confidence < 0.5`：标记为"无效"或"待观察"
  - `0.5 <= confidence <= 0.85`：需要人工复核
  - `confidence > 0.85`：系统自动采纳
- 可通过环境变量 `HUMAN_REVIEW_MIN_THRESHOLD` 和 `HUMAN_REVIEW_MAX_THRESHOLD` 配置

### 3. 人工复核结果反馈

提供API接口用于提交人工复核结果，支持：
- 提交人工复核的情感判断
- 对比模型结果与人工结果
- 统计复核数据，用于模型优化

---

## 🔧 配置说明

### 环境变量配置

在 `.env` 文件或环境变量中设置：

```bash
# 人机协同配置
HUMAN_REVIEW_MIN_THRESHOLD=0.5  # 需要人工复核的最小置信度（< 0.5 标记为无效/待观察）
HUMAN_REVIEW_MAX_THRESHOLD=0.85  # 需要人工复核的最大置信度（> 0.85 自动采纳，0.5-0.85 需要人工复核）
AUTO_ADD_TO_TRAINING=true       # 是否自动将人工复核结果添加到训练数据
AUTO_RETRAIN_ON_UPDATE=false    # 是否在添加新数据时自动重训练模型（建议false，手动控制）
```

**阈值建议**：
- **默认配置（0.5-0.85）**：平衡配置，推荐使用
  - `< 0.5`：标记为无效/待观察，不进行人工复核
  - `0.5-0.85`：需要人工复核，确保准确性
  - `> 0.85`：自动采纳，减少人工工作量
- **更严格（0.6-0.9）**：更多评论需要人工复核，准确率更高
- **更宽松（0.4-0.7）**：减少人工复核工作量，但可能遗漏部分不确定评论

**自动添加到训练数据**：
- **true**（推荐）：人工复核结果自动保存到 `training_data.json`，用于后续模型优化
- **false**：仅记录复核结果，不自动添加到训练数据

**自动重训练**：
- **true**：每次添加新数据时自动重新训练模型（可能影响性能）
- **false**（推荐）：手动调用 `/api/retrain` 接口重新训练，更灵活

---

## 📡 API接口说明

### 1. 单条评论分析（已集成人机协同）

**接口**：`POST /api/analyze`

**响应示例**：
```json
{
  "text": "评论内容",
  "sentiment": {
    "sentiment": "positive",
    "confidence": 0.65,
    "human_review_needed": true,
    "review_status": "needs_review",
    "review_reason": "置信度在复核区间内（0.5 <= 0.65 <= 0.85），需要人工复核",
    ...
  },
  "analysis_info": {
    "method": "ml",
    "confidence": 0.65,
    "human_review_needed": true,
    "review_status": "needs_review",
    "confidence_thresholds": {
      "min": 0.5,
      "max": 0.85
    }
  }
}
```

**字段说明**：
- `sentiment.confidence`：模型输出的置信度（0.0-1.0）
- `sentiment.human_review_needed`：是否需要人工复核（true/false）
- `sentiment.review_status`：复核状态（"invalid" | "needs_review" | "auto_accepted"）
- `sentiment.review_reason`：复核原因说明
- `analysis_info.confidence_thresholds`：当前使用的置信度区间配置（min/max）

### 2. 批量评论分析（已集成人机协同）

**接口**：`POST /api/analyze-batch`

**响应示例**：
```json
{
  "results": [
    {
      "text": "评论1",
      "sentiment": {...},
      "human_review_needed": true,
      "confidence": 0.65
    },
    {
      "text": "评论2",
      "sentiment": {...},
      "human_review_needed": false,
      "confidence": 0.85
    }
  ],
  "statistics": {
    "human_review": {
      "needed_count": 5,
      "total_count": 20,
      "review_rate": 25.0
    }
  }
}
```

**统计信息**：
- `statistics.human_review.needed_count`：需要人工复核的评论数量
- `statistics.human_review.total_count`：总评论数
- `statistics.human_review.review_rate`：需要复核的比例（%）

### 3. 提交人工复核结果

**接口**：`POST /api/human-review`

**请求示例**：
```json
{
  "comment_id": "comment_001",  // 可选，用于追踪
  "text": "评论内容",
  "reviewed_sentiment": "positive",  // 人工复核的情感：positive/negative/neutral
  "reviewed_confidence": 0.9,  // 可选，人工复核的置信度
  "review_notes": "人工复核备注"  // 可选
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "人工复核结果已提交",
  "comment_id": "comment_001",
  "comparison": {
    "model_sentiment": "positive",
    "model_confidence": 0.65,
    "reviewed_sentiment": "positive",
    "reviewed_confidence": 0.9,
    "is_consistent": true,  // 模型结果与人工结果是否一致
    "was_low_confidence": true  // 是否因为低置信度而需要复核
  },
  "note": "人工复核结果可用于后续模型优化和训练数据增强"
}
```

### 4. 获取人工复核统计

**接口**：`GET /api/human-review/stats`

**响应示例**：
```json
{
  "total_reviews": 50,
  "statistics": {
    "consistent_count": 42,
    "inconsistent_count": 8,
    "consistency_rate": 84.0,  // 模型与人工结果一致率
    "low_confidence_count": 45,
    "low_confidence_rate": 90.0,  // 低置信度评论占比
    "reviewed_sentiment_distribution": {
      "positive": 30,
      "negative": 15,
      "neutral": 5
    }
  },
  "confidence_thresholds": {
    "min": 0.5,
    "max": 0.85
  }
}
```

### 5. 获取配置信息（已包含人机协同配置）

**接口**：`GET /api/config`

**响应示例**：
```json
{
  "analysis_modes": {...},
  "current_status": {...},
  "human_review_config": {
    "enabled": true,
    "confidence_thresholds": {
      "min": 0.5,
      "max": 0.85
    },
    "description": "置信度规则：< 0.5 标记为无效/待观察，0.5-0.85 需要人工复核，> 0.85 自动采纳"
  }
}
```

---

## 💡 使用流程

### 流程1：模型初筛 + 人工复核

```
1. 调用 /api/analyze 或 /api/analyze-batch 进行评论分析
   ↓
2. 模型对所有评论进行初筛，输出置信度
   ↓
3. 系统根据置信度阈值自动标记需要人工复核的评论
   ↓
4. 前端展示分析结果，高亮显示需要人工复核的评论
   ↓
5. 人工复核低置信度评论
   ↓
6. 调用 /api/human-review 提交复核结果
   ↓
7. 系统对比模型结果与人工结果，统计一致性
   ↓
8. 使用人工复核数据优化模型（可选）
```

### 流程2：批量分析 + 统计

```
1. 批量分析评论，获取需要人工复核的评论列表
   ↓
2. 查看统计信息：复核率、一致性等
   ↓
3. 优先复核低置信度评论
   ↓
4. 提交复核结果，用于模型优化
```

---

## 📊 数据说明

### 置信度含义

- **0.8-1.0**：模型非常确定，系统自动采纳
- **0.5-0.8**：模型较为确定，但需要人工复核以确保准确性
- **0.0-0.5**：模型很不确定，标记为无效/待观察，不进行人工复核

### 人工复核价值

- **低置信度评论**：模型不确定的评论，人工复核价值高
- **不一致结果**：模型与人工结果不一致的评论，可用于模型优化
- **复核数据**：可用于扩充训练数据，提升模型准确性

---

## 🔄 模型优化流程（自动）

### 自动添加到训练数据

当 `AUTO_ADD_TO_TRAINING=true` 时，系统会自动：

1. **接收人工复核结果**：用户提交复核结果
2. **自动去重检查**：检查该评论是否已存在于训练数据中
3. **添加到训练数据**：将复核结果保存到 `training_data.json`
4. **自动重训练**（可选）：如果 `AUTO_RETRAIN_ON_UPDATE=true`，自动重新训练模型

### 工作流程

```
用户提交人工复核结果
  ↓
检查是否已存在（去重）
  ↓
添加到 training_data.json
  ↓
（可选）自动重新训练模型
  ↓
下次分析时使用优化后的模型
```

### 手动重训练模型

如果 `AUTO_RETRAIN_ON_UPDATE=false`（推荐），可以手动调用：

**接口**：`POST /api/retrain`

**响应示例**：
```json
{
  "success": true,
  "message": "模型重新训练成功",
  "training_data_count": 150,
  "model_info": {
    "is_trained": true,
    "training_data_count": 150,
    "model_type": "MultinomialNB"
  }
}
```

### 数据格式

人工复核结果会自动转换为训练数据格式：

```json
{
  "text": "评论内容",
  "label": "positive"  // 或 "negative" / "neutral"
}
```

### 优势

1. **持续优化**：每次人工复核都会增强模型
2. **自动去重**：避免重复数据
3. **灵活控制**：可选择自动或手动重训练
4. **数据持久化**：训练数据保存在文件中，重启后仍有效

---

## ⚙️ 配置建议

### 不同场景的阈值设置

**场景1：高准确率要求**
```bash
HUMAN_REVIEW_MAX_THRESHOLD=0.9
```
- 更多评论需要人工复核
- 准确率更高
- 适合对准确率要求极高的场景

**场景2：平衡效率与准确率（推荐）**
```bash
HUMAN_REVIEW_MAX_THRESHOLD=0.85
```
- 平衡人工复核工作量与准确率
- 适合大多数场景（默认配置）

**场景3：提高效率**
```bash
HUMAN_REVIEW_MAX_THRESHOLD=0.75
```
- 减少人工复核工作量
- 适合对效率要求高的场景

---

## 📝 注意事项

1. **阈值调整**：根据实际业务需求调整置信度阈值，平衡准确率与效率
2. **数据存储**：当前使用内存存储复核结果，实际应用中应使用数据库
3. **模型优化**：定期使用人工复核数据优化模型，提升准确率
4. **统计分析**：定期查看复核统计，了解模型表现和优化方向

---

## 🚀 后续优化建议

1. **数据库存储**：将人工复核结果存储到数据库，支持持久化和查询
2. **自动优化**：基于人工复核数据自动扩充训练数据并重新训练模型
3. **优先级排序**：根据置信度对需要复核的评论进行优先级排序
4. **批量复核**：支持批量提交人工复核结果
5. **复核历史**：记录复核历史，支持查看和追溯

